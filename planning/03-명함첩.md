# 명함첩 (CardBook) 도메인

## 개요
타인 명함 스캔/저장 및 관리 (그룹, 태그, 메모)

---

## 엔티티

### CardBook
| 필드 | 타입 | 설명 |
|------|------|------|
| id | string | 명함첩 항목 ID |
| memberId | string | 소유자 ID |
| cardId | string | 원본 명함 ID |
| profileSnapshot | object | 저장 당시 명함 정보 |
| groupId | string | 소속 그룹 ID (nullable) |
| memo | string | 메모 (nullable) |
| isFavorite | boolean | 즐겨찾기 여부 |
| savedAt | datetime | 저장일시 |
| updatedAt | datetime | 수정일시 |

### Group
- `group` 예약어로 인해 생성 시 card_book_group으로 생성
  
| 필드 | 타입 | 설명 |
|------|------|------|
| id | string | 그룹 ID |
| memberId | string | 소유자 ID |
| name | string | 그룹명 |
| sort_order | number | 정렬 순서 |
| createdAt | datetime | 생성일시 |
| updatedAt | datetime | 수정일시 |

### Tag
| 필드 | 타입 | 설명 |
|------|------|------|
| id | string | 태그 ID |
| memberId | string | 소유자 ID |
| name | string | 태그명 |
| color | string | 색상 코드 (HEX) |
| createdAt | datetime | 생성일시 |

### CardBookTag (다대다)
| 필드 | 타입 | 설명 |
|------|------|------|
| cardBookId | string | 명함첩 항목 ID |
| tagId | string | 태그 ID |

### ScanHistory
| 필드 | 타입 | 설명 |
|------|------|------|
| id | string | 기록 ID |
| scannerId | string | 스캔한 회원 ID |
| scannedCardId | string | 스캔된 명함 ID |
| scannedAt | datetime | 스캔 일시 |

### CardExchange
| 필드          | 타입 | 설명                 |
|-------------|------|--------------------|
| id          | string | 교환 기록 ID           |
| senderId    | string | 발신자 ID (명함 보내는 사람) |
| receiverId  | string | 수신자 ID (명함 받는 사람)  |
| exchangedAt | datetime | 교환일시               |

---

## 규칙 및 정책

### 스캔 규칙
| 규칙 | 내용 |
|------|------|
| 비회원 스캔 | 명함 열람만 가능, 저장 불가 |
| 자기 명함 스캔 | 스캔 가능하나 저장 불가 (본인 명함) |
| 스캔 기록 | 회원이 스캔한 경우만 기록 |
| 중복 스캔 | 동일 명함 재스캔 시 기존 기록 업데이트 |

### 명함 저장 규칙
| 규칙 | 내용 |
|------|------|
| 저장 권한 | 회원만 가능 |
| 중복 저장 | 동일 명함 중복 저장 불가 |
| 저장 개수 | 무제한 |
| 스냅샷 | 저장 시점의 명함 정보 보관 |

### 상호 교환 규칙
| 규칙 | 내용 |
|------|------|
| 발동 조건 | 명함 저장 완료 후 팝업 표시 |
| 전송 대상 | 상대방이 회원인 경우만 전송 가능 |
| 알림 방식 | 푸시 알림 + 인앱 알림 |
| 저장 방식 | 상대방이 알림 확인 후 직접 저장 |

### 그룹 규칙
| 규칙 | 내용 |
|------|------|
| 기본 그룹 | 전체, 즐겨찾기, 최근 (시스템 제공, 삭제 불가) |
| 최근 기준 | 7일 이내 저장된 명함 |
| 커스텀 그룹 | 최대 50개 |
| 그룹명 | 1-20자, 중복 불가 |
| 명함 소속 | 커스텀 그룹은 1개만 소속 가능 (즐겨찾기·최근은 조건 충족 시 자동 포함) |

### 태그 규칙
| 규칙 | 내용 |
|------|------|
| 최대 개수 | 회원당 100개 |
| 태그명 | 1-15자, 중복 불가 |
| 명함당 태그 | 최대 10개 |
| 색상 | HEX 코드 (기본 색상 팔레트 제공) |

### 메모 규칙
| 규칙 | 내용 |
|------|------|
| 길이 | 최대 500자 |
| 수정 | 언제든 수정 가능 |

### 스캔 기록 규칙
| 규칙 | 내용 |
|------|------|
| 보관 기간 | 최근 1년 |
| 삭제 | 수동 삭제 가능 |
| "나를 스캔" | 상대방이 회원이고 스캔한 경우만 표시 |

---

## 기능

### 1. QR 스캔
- 인앱 카메라로 QR 스캔
- 스캔 시 상대방 명함 표시

### 2. 명함 저장
- 스캔 후 저장 버튼
- 저장 시 "내 명함도 전송" 팝업 (양방향 교환)

### 3. 명함첩 목록
- 전체/그룹별/태그별 조회
- 검색 기능 (이름, 회사, 태그)
- 즐겨찾기

### 4. 그룹 관리
- 기본 그룹: 전체, 즐겨찾기, 최근
- 커스텀 그룹 생성/수정/삭제
- 그룹 순서 변경

### 5. 태그 관리
- 명함에 다중 태그 지정
- 태그 색상 설정
- 태그 생성/수정/삭제

### 6. 명함 상세
- 저장된 명함 정보 조회
- 메모 추가/수정
- 기기 연락처 앱 동기화

### 7. 스캔 기록
- 내가 스캔한 기록
- 나를 스캔한 기록 (회원인 경우)

---

## 시나리오

### 시나리오 1: 명함 스캔 및 저장
```
1. 홈 → 스캔 버튼 클릭
2. 카메라 열림
3. 상대방 QR 코드 스캔
4. 상대방 명함 화면 표시
5. [저장] 버튼 클릭
6. 명함 저장 완료
7. 팝업: "내 명함도 전송하시겠습니까?"
8. [예] 클릭 → 상대방에게 푸시 알림 발송
```

### 시나리오 2: 상호 교환 수신
```
1. A가 B의 명함을 저장하고 "내 명함 전송" 선택
2. B에게 푸시 알림: "A님이 명함을 보냈습니다"
3. B가 알림 탭
4. A의 명함 조회 화면 표시
5. B가 [저장] 버튼 클릭
6. A의 명함이 B의 명함첩에 저장됨
```

### 시나리오 3: 그룹으로 명함 관리
```
1. 컨퍼런스에서 여러 명함 수집
2. 명함첩 → [+ 새 그룹 만들기]
3. 그룹명 "2024 테크 컨퍼런스" 입력
4. 저장된 명함들 선택
5. 해당 그룹으로 이동
6. 나중에 그룹별로 쉽게 조회
```

### 시나리오 4: 태그로 명함 분류
```
1. 명함 상세 화면 진입
2. 태그 섹션 → [+ 추가] 클릭
3. 기존 태그 선택 또는 새 태그 생성
4. "투자자", "VIP" 태그 추가
5. 명함첩에서 태그로 필터링 가능
```

### 시나리오 5: 명함 검색
```
1. 명함첩 → 검색 아이콘 클릭
2. "ABC Company" 입력
3. 회사명에 "ABC Company" 포함된 명함 표시
4. 또는 태그 "#투자자"로 검색
5. 해당 태그 가진 명함들 표시
```

### 시나리오 6: 기기 연락처 동기화
```
1. 명함 상세 → [연락처에 저장] 클릭
2. 연락처 접근 권한 요청 (최초 1회)
3. 기기 연락처 앱에 정보 저장
4. 전화/문자 앱에서 바로 연락 가능
```

### 시나리오 7: 비회원 스캔 → 가입 유도
```
1. 비회원이 QR 스캔
2. 명함 화면 표시 (열람 가능)
3. [저장] 버튼 클릭
4. "명함을 저장하려면 로그인이 필요합니다" 팝업
5. [로그인] 또는 [회원가입] 선택
6. 가입 완료 후 해당 명함 자동 저장
```

---

## 화면

### 스캔 카메라
```
┌─────────────────────────────┐
│  ╔═══════════════════════╗  │
│  ║                       ║  │
│  ║    [카메라 뷰파인더]   ║  │
│  ║                       ║  │
│  ║    ┌───────────┐      ║  │
│  ║    │  QR 영역  │      ║  │
│  ║    └───────────┘      ║  │
│  ║                       ║  │
│  ╚═══════════════════════╝  │
│                             │
│     QR 코드를 스캔하세요     │
└─────────────────────────────┘
```

### 저장 완료 팝업
```
┌─────────────────────────────┐
│  명함이 저장되었습니다!      │
│                             │
│  내 명함도 전송하시겠습니까? │
│                             │
│  ┌─────────┐ ┌─────────┐   │
│  │   예    │ │ 아니오  │   │
│  └─────────┘ └─────────┘   │
└─────────────────────────────┘
```

### 명함첩 메인
```
┌─────────────────────────────┐
│  내 명함첩          🔍      │
│                             │
│  📁 전체 (47)               │
│  ⭐ 즐겨찾기 (12)            │
│  🕐 최근 (5)                │
│  ─────────────────          │
│  📁 거래처 (15)             │
│  📁 스타트업 (8)            │
│  📁 2024 컨퍼런스 (7)       │
│                             │
│  + 새 그룹 만들기           │
└─────────────────────────────┘
```

### 그룹 내 목록
```
┌─────────────────────────────┐
│  ← 거래처 (15)        필터  │
│                             │
│  ┌─────────────────────┐   │
│  │ [사진] 홍길동        │   │
│  │ PM @ ABC Company    │   │
│  │ #잠재고객 #VIP       │   │
│  └─────────────────────┘   │
│                             │
│  ┌─────────────────────┐   │
│  │ [사진] 김철수        │   │
│  │ 대표 @ XYZ Inc      │   │
│  │ #파트너             │   │
│  └─────────────────────┘   │
└─────────────────────────────┘
```

### 명함 상세
```
┌─────────────────────────────┐
│  ←                    ⭐ ⋮  │
│                             │
│     [프로필 사진]            │
│     홍길동                   │
│     Product Manager         │
│     ABC Company             │
│                             │
│  📞 010-1234-5678   [전화]  │
│  ✉️  hong@abc.com   [메일]  │
│                             │
│  ── 태그 ──                 │
│  #잠재고객  #VIP  + 추가    │
│                             │
│  ── 메모 ──                 │
│  다음 주 미팅 제안          │
│  [메모 수정]                │
│                             │
│  📱 연락처에 저장           │
│                             │
│  저장일: 2024.01.15         │
└─────────────────────────────┘
```

### 스캔 기록
```
┌─────────────────────────────┐
│  스캔 기록                   │
│                             │
│  [내가 스캔] [나를 스캔]     │
│                             │
│  ── 오늘 ──                 │
│  [사진] 홍길동    오후 2:30  │
│  [사진] 김철수    오전 11:00 │
│                             │
│  ── 어제 ──                 │
│  [사진] 이영희    오후 5:00  │
│                             │
│  ── 2024.01.13 ──           │
│  [사진] 박민수    오후 3:00  │
└─────────────────────────────┘
```

---

## 플로우

### 스캔 → 저장 → 상호 교환
```
[스캔 버튼]
    │
    ▼
[카메라 열기]
    │
    ▼
[QR 인식]
    │
    ▼
[명함 조회 API 호출]
    │
    ▼
[명함 화면 표시]
    │
    ▼
[저장 클릭] ─────────────────────┐
    │                            │
    ├─→ 비회원 → 로그인 유도      │
    │                            │
    └─→ 회원 → [명함 저장 API]    │
              │                  │
              ▼                  │
        [저장 완료]               │
              │                  │
              ▼                  │
        [팝업: 내 명함도 전송?]   │
              │                  │
              ├─→ 예             │
              │     │            │
              │     ▼            │
              │   [교환 API]     │
              │     │            │
              │     ▼            │
              │   상대방 푸시알림 │
              │     │            │
              │     ▼            │
              │   상대방이 알림  │
              │   확인 후 저장   │
              │                  │
              └─→ 아니오 → 종료   │
```

---

## API

### 스캔
| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | /api/scan | 스캔 기록 저장 |
| GET | /api/scan/history | 내가 스캔한 기록 |
| GET | /api/scan/scanned-me | 나를 스캔한 기록 |
| POST | /api/scan/:id/delete | 스캔 기록 삭제 |

### 명함첩
| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | /api/cardbooks | 명함 저장 |
| POST | /api/cardbooks/exchange | 명함 교환 (내 명함 전송) |
| GET | /api/cardbooks | 명함첩 목록 (필터, 검색, 페이징) |
| GET | /api/cardbooks/:id | 명함 상세 |
| POST | /api/cardbooks/v1/:id/group | 명함첩 그룹 수정 |
| POST | /api/cardbooks/v1/:id/memo | 명함첩 메모 수정 |
| POST | /api/cardbooks/v1/:id/favorite | 명함첩 즐겨찾기 수정 |
| POST | /api/cardbooks/:id/delete | 명함 삭제 |
| POST | /api/cardbooks/:id/sync-contact | 기기 연락처 동기화 |

### 그룹
| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | /api/groups | 그룹 생성 |
| GET | /api/groups | 그룹 목록 (개수 포함) |
| POST | /api/groups/:id/rename | 그룹명 수정 |
| POST | /api/groups/reorder | 그룹 순서 변경 |
| POST | /api/groups/:id/delete | 그룹 삭제 |

### 태그
| Method | Endpoint | 설명 |
|--------|----------|------|
| POST | /api/tags | 태그 생성 |
| GET | /api/tags | 태그 목록 |
| POST | /api/tags/:id/update | 태그 수정 |
| POST | /api/tags/:id/delete | 태그 삭제 |
| POST | /api/cardbooks/:id/tags | 명함에 태그 추가 |
| POST | /api/cardbooks/:id/tags/:tagId/remove | 명함에서 태그 제거 |

---

## API 상세

### POST /api/cardbooks
명함 저장
```json
// Request
{
  "cardId": "uuid",
  "groupId": "uuid",        // optional
  "memo": "CES에서 만남"     // optional
}

// Response: 201 Created
{
  "id": "uuid",
  "card": {
    "id": "uuid",
    "name": "홍길동",
    "title": "Product Manager",
    "company": "ABC Company",
    ...
  },
  "groupId": "uuid",
  "memo": "CES에서 만남",
  "isFavorite": false,
  "tags": [],
  "savedAt": "2024-01-01T00:00:00Z"
}
```

### POST /api/cardbooks/exchange
명함 교환 (내 명함 전송) - 명함 저장 후 "내 명함 전송" 선택 시 호출
```json
// Request
{
  "receiverId": "uuid"    // 받는 사람의 member ID
}

// Response: 201 Created
{
  "id": "uuid",
  "senderId": "uuid",
  "receiverId": "uuid",
  "createdAt": "2024-01-01T00:00:00Z"
}

// 서버 동작:
// 1. card_exchanges 테이블에 기록 저장
// 2. notifications 테이블에 알림 저장 (알림 히스토리용)
// 3. 상대방에게 푸시 알림 발송 (실시간 알림용)
//
// 알림 수신자 플로우:
// 1. 푸시 알림 탭 → 발신자 명함 조회 화면으로 이동
// 2. 저장하려면 POST /api/cardbooks 호출 (기존 저장 API)
```

### GET /api/cardbooks
명함첩 목록 조회
```json
// Query Parameters
// - groupId: 특정 그룹 필터
// - favorite: true면 즐겨찾기만
// - search: 이름/회사/직책 검색
// - tagId: 특정 태그 필터
// - page, size: 페이징

// Response
{
  "cardBooks": [
    {
      "id": "uuid",
      "card": {
        "id": "uuid",
        "name": "홍길동",
        "title": "PM",
        "company": "ABC",
        "profileImage": "https://..."
      },
      "groupId": "uuid",
      "memo": "CES에서 만남",
      "isFavorite": true,
      "tags": [
        { "id": "uuid", "name": "VIP", "color": "#4F46E5" }
      ],
      "savedAt": "2024-01-01T00:00:00Z"
    }
  ],
  "page": 0,
  "size": 20,
  "totalElements": 47,
  "totalPages": 3
}
```

### GET /api/cardbooks/:id
명함 상세 조회
```json
// Response
{
  "id": "uuid",
  "card": {
    "id": "uuid",
    "memberId": "uuid",
    "name": "홍길동",
    "title": "Product Manager",
    "company": "ABC Company",
    "phone": "010-1234-5678",
    "email": "hong@abc.com",
    "bio": "열정적인 PM입니다",
    "profileImage": "https://...",
    "portfolio": "https://...",
    "location": "Seoul",
    "qrImageUrl": "https://...",
    "socialLinks": [...],
    "createdAt": "...",
    "updatedAt": "..."
  },
  "group": {
    "id": "uuid",
    "name": "거래처"
  },
  "memo": "CES에서 만남. AI 협업 논의.",
  "isFavorite": true,
  "tags": [
    { "id": "uuid", "name": "VIP", "color": "#4F46E5" },
    { "id": "uuid", "name": "AI", "color": "#10B981" }
  ],
  "savedAt": "2024-01-01T00:00:00Z"
}
```

### POST /api/cardbooks/:id/update
명함 정보 수정 (그룹, 메모, 태그)
```json
// Request
{
  "groupId": "uuid",        // optional, null이면 그룹 해제
  "memo": "수정된 메모",     // optional
  "tagIds": ["uuid", "uuid"] // optional, 전체 교체
}

// Response: 200 OK (상세 조회와 동일)
```

---

## 개발 우선순위
1. Phase 1: QR 스캔, 명함 저장, 상호 교환 팝업
2. Phase 2: 그룹/태그, 검색, 스캔 기록, 연락처 동기화
